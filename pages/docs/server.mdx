# WebæœåŠ¡å™¨

æœ¬ç« å°†ä»‹ç»é©±åŠ¨NestJSå’ŒSpringBootä¸Šå±‚æ¡†æ¶çš„åº•å±‚WebæœåŠ¡å™¨ã€‚

## Express

NestJSåœ¨åº•å±‚ä½¿ç”¨äº†Expressä½œä¸ºå…¶WebæœåŠ¡å™¨ä¹‹ä¸€ã€‚è¿™æ„å‘³ç€ï¼Œå½“ä½ ä½¿ç”¨NestJSæ„å»ºåº”ç”¨ç¨‹åºæ—¶ï¼Œä½ å®é™…ä¸Šæ˜¯åœ¨ä½¿ç”¨Expressçš„æ‰€æœ‰åŠŸèƒ½ï¼Œä½†ä»¥ä¸€ç§æ›´ç»“æ„åŒ–å’Œæ¨¡å—åŒ–çš„æ–¹å¼ã€‚NestJSé€šè¿‡å…¶è£…é¥°å™¨å’Œæ¨¡å—ç³»ç»Ÿï¼Œä¸ºExpressæä¾›äº†é¢å¤–çš„æŠ½è±¡å±‚ï¼Œä½¿å¾—ä»£ç æ›´åŠ æ•´æ´å’Œæ˜“äºç»´æŠ¤ã€‚

### ä½¿ç”¨ Express

1. **å®‰è£… Express**

```bash
pnpm add express
```

ç”±äº Express æ˜¯ä½¿ç”¨ JavaScript ç¼–å†™çš„ï¼Œå› æ­¤éœ€è¦é¢å¤–å®‰è£… Express çš„ TypeScript ç±»å‹å£°æ˜

```bash
pnpm add -D @types/express # -D é€‰é¡¹è¡¨ç¤ºå®‰è£…ä¾èµ–é¡¹åˆ°å¼€å‘ç¯å¢ƒï¼Œç”Ÿäº§ç¯å¢ƒæ„å»ºçš„æ—¶å€™ä¸éœ€è¦åŒ…å«è¯¥ä¾èµ–é¡¹
```

2. **åˆ›å»º Express åº”ç”¨ç¨‹åº**

```typescript filename="index.ts" showLineNumbers
import Express from 'express';

const app = Express();

app.get('/', (req, res) => {
    res.send('Hello World');
});

app.listen(8080, () => {
    console.log('Server is running on http://localhost:8080');
});
```
3. **å¯åŠ¨åº”ç”¨ç¨‹åº**

é…ç½®å¼€å‘ç¯å¢ƒå¯åŠ¨å‘½ä»¤

```json {7} filename="package.json" showLineNumbers
{
	"name": "@ell/api",
	"version": "1.0.0",
	"scripts": {
		"build": "tsc ./src/index.ts",
		"start": "node ./dist/index.js",
		"dev": "tsx watch ./src/index.ts"
	},
	"dependencies": {
		"express": "^4.21.1"
	},
	"devDependencies": {
		"@types/express": "^5.0.0",
		"tsx": "^4.19.2",
		"typescript": "^5.7.2"
	}
}
```
å¯åŠ¨æœåŠ¡å™¨

```ansi
(base) [0;32m âœ [0m [38;5;31mapi[0m pnpm dev

> @ell/api@1.0.0 dev /Users/roylin/Desktop/ell/pnpm-mono/apps/api
> tsx ./src/index.ts

Server is running on [0;32mhttp://localhost:8080[0m
```
æµè§ˆå™¨è®¿é—®: [http://localhost:8080](http://localhost:8080) å¯ä»¥çœ‹åˆ°è¾“å‡º `Hello World`

4. **ä½¿ç”¨ä¸­é—´ä»¶**

ç¼–å†™ä¸€ä¸ªç®€å•çš„æ—¥å¿—ä¸­é—´ä»¶ã€‚è¿™ä¸ªä¸­é—´ä»¶å°†è®°å½•æ¯ä¸ªè¯·æ±‚çš„æ–¹æ³•ã€è·¯å¾„å’Œå“åº”æ—¶é—´ã€‚

```typescript {3-12, 16} filename="index.ts" showLineNumbers
import Express from 'express';

const logger = (req: Express.Request, res: Express.Response, next: Express.NextFunction) => {
    const start = Date.now(); // è¯·æ±‚å¼€å§‹æ—¶é—´ 

    res.on('finish', () => { // å½“å“åº”ç»“æŸæ—¶è§¦å‘
        const duration = Date.now() - start; // è®¡ç®—å“åº”æ—¶é—´
        console.log(`${req.method} ${req.url} ${res.statusCode} ${duration}ms`); // è®°å½•æ—¥å¿—
    });

    next(); // ç»§ç»­å¤„ç†è¯·æ±‚
}

const app = Express();

app.use(logger);

app.get('/', (req, res) => {
    res.send('Hello World');
});

app.listen(8080, () => {
    console.log('Server is running on http://localhost:8080');
});
```
å†æ¬¡è®¿é—® http://localhost:8080 å¯ä»¥çœ‹åˆ°æµè§ˆå™¨è¾“å‡º `Hello World` çš„åŒæ—¶ï¼Œç»ˆç«¯è¾“å‡ºäº†æ—¥å¿—ã€‚

```ansi
GET / 200 1ms
```

## Tomcat

SpringBoot åœ¨åº•å±‚ä½¿ç”¨äº† Tomcat ä½œä¸ºå…¶å†…åµŒ Web æœåŠ¡å™¨ä¹‹ä¸€ã€‚è¿™æ„å‘³ç€ï¼Œå½“ä½ ä½¿ç”¨ SpringBoot æ„å»ºåº”ç”¨ç¨‹åºæ—¶ï¼Œä½ å®é™…ä¸Šæ˜¯åœ¨ä»¥ä¸€ç§æ›´ç®€æ´å’Œè‡ªåŠ¨åŒ–çš„æ–¹å¼ä½¿ç”¨ Tomcat çš„æ‰€æœ‰åŠŸèƒ½ã€‚SpringBoot é€šè¿‡å…¶è‡ªåŠ¨é…ç½®å’Œ startersï¼Œä¸º Tomcat æä¾›äº†é¢å¤–çš„æŠ½è±¡å±‚ï¼Œä½¿å¾—ä»£ç æ›´åŠ æ•´æ´å’Œæ˜“äºç»´æŠ¤ã€‚

### ä½¿ç”¨ Tomcat

1. **å®‰è£… Tomcat**

```xml {12-16} filename="pom.xml" showLineNumbers
<project>
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.ell</groupId>
        <artifactId>maven-monorepo</artifactId>
        <version>1.0.0-SNAPSHOT</version>
        <relativePath>../pom.xml</relativePath>
    </parent>
    <artifactId>api</artifactId>

    <dependencies>
        <dependency>
            <groupId>org.apache.tomcat.embed</groupId>
            <artifactId>tomcat-embed-core</artifactId>
            <version>8.5.100</version>
        </dependency>
        <dependency>
            <groupId>com.ell</groupId>
            <artifactId>packagea</artifactId>
            <version>1.0.0-SNAPSHOT</version>
        </dependency>
        <dependency>
            <groupId>com.ell</groupId>
            <artifactId>packageb</artifactId>
            <version>1.0.0-SNAPSHOT</version>
        </dependency>
    </dependencies>

    <build>
        <pluginManagement>
            <plugins>          
                <plugin>
                    <groupId>org.codehaus.mojo</groupId>
                    <artifactId>exec-maven-plugin</artifactId>
                    <version>3.0.0</version>
                    <configuration>
                        <mainClass>com.ell.api.Api</mainClass>
                    </configuration>
                </plugin>      
            </plugins>
        </pluginManagement>
    </build>
</project>
```

2. **åˆ›å»º Tomcat åº”ç”¨ç¨‹åº**

```java filename="Api.java" showLineNumbers
package com.ell.api;

import java.io.File;
import java.io.IOException;
import java.io.PrintWriter;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.catalina.LifecycleException;
import org.apache.catalina.startup.Tomcat;

public class Api {
    public static void main(String[] args) throws LifecycleException {
        Tomcat tomcat = new Tomcat();
        tomcat.setPort(8080);
        tomcat.setBaseDir("temp");

        tomcat.addContext("", new File(".").getAbsolutePath());

        tomcat.addServlet("", "hello", new HttpServlet() {
            @Override
            protected void doGet(HttpServletRequest req, HttpServletResponse resp)
                    throws ServletException, IOException {
                PrintWriter writer = resp.getWriter();
                writer.write("Hello World");
            }
        }).addMapping("/");

        tomcat.start();
        System.out.println("Server is running on http://localhost:8080");
        tomcat.getServer().await();
    }
}
```

3. **å¯åŠ¨åº”ç”¨ç¨‹åº**

```ansi
(base) [0;32m âœ [0m [38;5;31mmaven-mono[0m mvn -f api/pom.xml exec:java
[[38;5;31mINFO[0m] Scanning for projects...
[[38;5;31mINFO[0m]
[[38;5;31mINFO[0m] ----------------------------< [38;5;31mcom.ell:api[0m >-----------------------------
[[38;5;31mINFO[0m] Building api 1.0.0-SNAPSHOT
[[38;5;31mINFO[0m]   from pom.xml
[[38;5;31mINFO[0m] --------------------------------[ jar ]---------------------------------
[[38;5;31mINFO[0m]
[[38;5;31mINFO[0m] --- exec:3.0.0:java (default-cli) @ api ---
11æœˆ 29, 2024 3:04:20 ä¸‹åˆ org.apache.coyote.AbstractProtocol init
ä¿¡æ¯: Initializing ProtocolHandler ["http-nio-8080"]
11æœˆ 29, 2024 3:04:20 ä¸‹åˆ org.apache.catalina.core.StandardService startInternal
ä¿¡æ¯: Starting service [Tomcat]
11æœˆ 29, 2024 3:04:20 ä¸‹åˆ org.apache.catalina.core.StandardEngine startInternal
ä¿¡æ¯: Starting Servlet engine: [Apache Tomcat/8.5.100]
11æœˆ 29, 2024 3:04:20 ä¸‹åˆ org.apache.coyote.AbstractProtocol start
ä¿¡æ¯: Starting ProtocolHandler ["http-nio-8080"]
Server is running on [0;32mhttp://localhost:8080[0m
```
æµè§ˆå™¨è®¿é—®: [http://localhost:8080](http://localhost:8080) å¯ä»¥çœ‹åˆ°è¾“å‡º `Hello World`

4. **ä½¿ç”¨è¿‡æ»¤å™¨**

é€šè¿‡åˆ›å»ºè¿‡æ»¤å™¨å¯ä»¥å®ç°å’Œ Express ä¸­é—´ä»¶ç±»ä¼¼çš„åŠŸèƒ½

```java
package com.ell.api;

import java.io.IOException;

import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

public class LoggerFilter implements Filter {

    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
    }

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {
        // è½¬æ¢ä¸ºHTTPè¯·æ±‚å’Œå“åº”ä»¥è®¿é—®ç‰¹å®šçš„æ–¹æ³•å’Œå±æ€§
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        HttpServletResponse httpResponse = (HttpServletResponse) response;

        // è¯·æ±‚å¼€å§‹æ—¶é—´
        long start = System.currentTimeMillis();

        // ç»§ç»­æ‰§è¡Œè¿‡æ»¤å™¨é“¾
        chain.doFilter(request, response);

        // è®¡ç®—å“åº”æ—¶é—´
        long duration = System.currentTimeMillis() - start;

        // è·å–å“åº”çŠ¶æ€ç 
        int statusCode = httpResponse.getStatus();

        // è®°å½•æ—¥å¿—
        String method = httpRequest.getMethod();
        String url = httpRequest.getRequestURI();
        log(method, url, statusCode, duration);
    }

    @Override
    public void destroy() {
    }

    private void log(String method, String url, int statusCode, long duration) {
        // æ„å»ºæ—¥å¿—ä¿¡æ¯
        String logMessage = String.format("%s %s %d %dms", method, url, statusCode, duration);
        System.out.println(logMessage); // è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œä¹Ÿå¯ä»¥æ”¹ä¸ºè®°å½•åˆ°æ–‡ä»¶æˆ–å…¶ä»–æ—¥å¿—ç³»ç»Ÿ
    }
}
```

è¦è®© Tomcat èƒ½æ­£ç¡®åŠ è½½è¿‡æ»¤å™¨ï¼Œéœ€è¦ä¸ºä¸Šä¸‹æ–‡å¯¹è±¡è®¾ç½®æ­£ç¡®çš„ç±»åŠ è½½å™¨

```java {24-26, 37-40, 42-45} filename="Api.java" showLineNumbers
package com.ell.api;

import java.io.File;
import java.io.IOException;
import java.io.PrintWriter;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.catalina.Context;
import org.apache.catalina.LifecycleException;
import org.apache.catalina.startup.Tomcat;
import org.apache.tomcat.util.descriptor.web.FilterDef;
import org.apache.tomcat.util.descriptor.web.FilterMap;

public class Api {
    public static void main(String[] args) throws LifecycleException {
        Tomcat tomcat = new Tomcat();
        tomcat.setPort(8080);
        tomcat.setBaseDir("temp");

        Context context = tomcat.addContext("", new File(".").getAbsolutePath());
        ClassLoader classLoader = tomcat.getClass().getClassLoader();
        context.setParentClassLoader(classLoader);

        tomcat.addServlet("", "hello", new HttpServlet() {
            @Override
            protected void doGet(HttpServletRequest req, HttpServletResponse resp)
                    throws ServletException, IOException {
                PrintWriter writer = resp.getWriter();
                writer.write("Hello World");
            }
        }).addMapping("/");

        FilterDef filterDef = new FilterDef();
        filterDef.setFilterClass(LoggerFilter.class.getName());
        filterDef.setFilterName("loggerFilter");
        context.addFilterDef(filterDef);

        FilterMap filterMap = new FilterMap();
        filterMap.setFilterName("loggerFilter");
        filterMap.addURLPattern("/*");
        context.addFilterMap(filterMap);

        tomcat.start();
        System.out.println("Server is running on http://localhost:8080");
        tomcat.getServer().await();
    }
}
```
å†æ¬¡è®¿é—® http://localhost:8080 å¯ä»¥çœ‹åˆ°æµè§ˆå™¨è¾“å‡º `Hello World` çš„åŒæ—¶ï¼Œç»ˆç«¯è¾“å‡ºäº†æ—¥å¿—ã€‚

```ansi
GET / 200 1ms
```